generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ----------------------
// ENUMS
// ----------------------

enum EstadoEmpresa {
  PENDIENTE
  ACTIVA
  INACTIVA
}

enum RolUsuario {
  ADMIN
  PROPIETARIO
  VENDEDOR
}

enum EstadoGenerico {
  ACTIVO
  INACTIVO
}

enum TipoVenta {
  FISICA
  ONLINE
}

enum MetodoPago {
  EFECTIVO
  QR
  TRANSFERENCIA
}

enum EstadoEntrega {
  PENDIENTE
  EN_CAMINO
  ENTREGADO
}

enum EstadoVenta {
  REGISTRADA
  PAGADA
  CANCELADA
}

enum EstadoCompra {
  PENDIENTE
  CONFIRMADA
  CANCELADA
}

enum EstadoSuscripcion {
  PENDIENTE
  ACTIVA
  VENCIDA
  CANCELADA
}

// Enum PlanNombre removed in favor of String for dynamic plans

// ----------------------
// MODELOS
// ----------------------

model Plan {
  plan_id            Int            @id @default(autoincrement())
  nombre_plan        String         @unique
  descripcion        String?
  max_usuarios       Int
  max_productos      Int
  ventas_online      Boolean        @default(false)
  reportes_avanzados Boolean        @default(false)
  precio_mensual     Decimal        @db.Decimal(10, 2)
  precio_anual       Decimal        @default(0) @db.Decimal(10, 2) // Default 0 for migration safety
  estado             EstadoGenerico @default(ACTIVO)

  tenants       Tenant[]
  suscripciones Suscripcion[]
}

model Tenant {
  tenant_id           Int           @id @default(autoincrement())
  nombre_empresa      String
  telefono            String?
  email               String        @unique
  direccion           String?
  moneda              String        @default("BOB")
  impuesto_porcentaje Decimal       @default(0) @db.Decimal(5, 2)
  logo_url            String?
  horario_atencion    String?
  slug                String?       @unique // URL de la tienda: /tienda/mi-slug
  banner_url          String?
  estado              EstadoEmpresa @default(PENDIENTE)
  fecha_registro      DateTime      @default(now())

  plan_id Int
  plan    Plan @relation(fields: [plan_id], references: [plan_id])

  rubros Rubro[] // Relación muchos a muchos implícita

  usuarios      Usuario[]
  productos     Producto[]
  ventas        Venta[]
  clientes      Cliente[]
  compras       Compra[]
  suscripciones Suscripcion[]
  categorias    Categoria[]
  proveedors    Proveedor[]
}

model Rubro {
  rubro_id    Int            @id @default(autoincrement())
  nombre      String         @unique // Ej: Farmacia, Restaurante
  descripcion String?
  estado      EstadoGenerico @default(ACTIVO)

  tenants Tenant[]
}

model Usuario {
  usuario_id      Int            @id @default(autoincrement())
  tenant_id       Int
  tenant          Tenant         @relation(fields: [tenant_id], references: [tenant_id])
  nombre          String
  paterno         String?
  materno         String?
  email           String         @unique
  password_hash   String
  rol             RolUsuario
  estado          EstadoGenerico @default(ACTIVO)
  fecha_creacion  DateTime       @default(now())
  reset_token     String?
  reset_token_exp DateTime?

  ventas         Venta[]
  compras        Compra[]
  notificaciones Notificacion[]

  @@index([tenant_id])
}

model Suscripcion {
  suscripcion_id  Int               @id @default(autoincrement())
  tenant_id       Int
  tenant          Tenant            @relation(fields: [tenant_id], references: [tenant_id])
  plan_id         Int
  plan            Plan              @relation(fields: [plan_id], references: [plan_id])
  fecha_inicio    DateTime
  fecha_fin       DateTime?
  monto           Decimal           @db.Decimal(10, 2)
  metodo_pago     MetodoPago
  estado          EstadoSuscripcion @default(ACTIVA)
  referencia      String?
  comprobante_url String? // URL del comprobante de pago
  creado_en       DateTime          @default(now())

  @@index([tenant_id])
}

model Cliente {
  cliente_id     Int            @id @default(autoincrement())
  tenant_id      Int
  tenant         Tenant         @relation(fields: [tenant_id], references: [tenant_id])
  nombre         String
  paterno        String?
  materno        String?
  email          String?
  telefono       String?
  nit_ci         String? // Documento de identidad / NIT
  password_hash  String? // Solo si tiene cuenta para carrito
  fecha_registro DateTime       @default(now())
  estado         EstadoGenerico @default(ACTIVO)

  ventas Venta[]

  @@index([tenant_id])
}

model Categoria {
  categoria_id Int            @id @default(autoincrement())
  tenant_id    Int // Categorías son específicas de cada tienda
  tenant       Tenant         @relation(fields: [tenant_id], references: [tenant_id])
  nombre       String
  descripcion  String?
  estado       EstadoGenerico @default(ACTIVO)

  productos Producto[]

  @@index([tenant_id])
}

model Proveedor {
  proveedor_id Int            @id @default(autoincrement())
  tenant_id    Int
  tenant       Tenant         @relation(fields: [tenant_id], references: [tenant_id])
  nombre       String
  telefono     String?
  email        String?
  datos_pago   String?
  estado       EstadoGenerico @default(ACTIVO)
  productos    Producto[]
  compras      Compra[]

  @@index([tenant_id])
}

model Producto {
  producto_id  Int            @id @default(autoincrement())
  tenant_id    Int
  tenant       Tenant         @relation(fields: [tenant_id], references: [tenant_id])
  categoria_id Int
  categoria    Categoria      @relation(fields: [categoria_id], references: [categoria_id])
  proveedor_id Int?
  proveedor    Proveedor?     @relation(fields: [proveedor_id], references: [proveedor_id])
  nombre       String
  slug         String? // URL amigable: /tienda/mi-tienda/producto-xyz (Debe ser único por tenant, pero Prisma lo hace global o compuesto)
  descripcion  String?
  precio       Decimal        @db.Decimal(10, 2)
  stock_actual Int            @default(0)
  stock_minimo Int            @default(5)
  destacado    Boolean        @default(false)
  estado       EstadoGenerico @default(ACTIVO)

  detalles_venta  DetalleVenta[]
  detalles_compra DetalleCompra[]
  imagenes        ProductoImagen[]

  @@unique([tenant_id, slug]) // Slug único por tenant
  @@index([tenant_id])
}

model ProductoImagen {
  imagen_id    Int            @id @default(autoincrement())
  producto_id  Int
  producto     Producto       @relation(fields: [producto_id], references: [producto_id])
  url          String
  orden        Int            @default(1)
  es_principal Boolean        @default(false)
  estado       EstadoGenerico @default(ACTIVO)

  @@unique([producto_id, orden])
  @@index([producto_id])
}

model Compra {
  compra_id    Int          @id @default(autoincrement())
  tenant_id    Int // Para saber de qué tenant es la compra (aunque el usuario lo linkea, es bueno tenerlo directo)
  tenant       Tenant       @relation(fields: [tenant_id], references: [tenant_id])
  proveedor_id Int
  proveedor    Proveedor    @relation(fields: [proveedor_id], references: [proveedor_id])
  usuario_id   Int
  usuario      Usuario      @relation(fields: [usuario_id], references: [usuario_id])
  fecha_compra DateTime     @default(now())
  total        Decimal      @db.Decimal(10, 2)
  estado       EstadoCompra @default(PENDIENTE)

  detalles DetalleCompra[]

  @@index([tenant_id])
}

model DetalleCompra {
  detalle_compra_id Int      @id @default(autoincrement())
  compra_id         Int
  compra            Compra   @relation(fields: [compra_id], references: [compra_id])
  producto_id       Int
  producto          Producto @relation(fields: [producto_id], references: [producto_id])
  cantidad          Int
  precio_unitario   Decimal  @db.Decimal(10, 2)
  subtotal          Decimal  @db.Decimal(10, 2)
}

model Venta {
  venta_id        Int           @id @default(autoincrement())
  tenant_id       Int
  tenant          Tenant        @relation(fields: [tenant_id], references: [tenant_id])
  cliente_id      Int?
  cliente         Cliente?      @relation(fields: [cliente_id], references: [cliente_id])
  usuario_id      Int
  usuario         Usuario       @relation(fields: [usuario_id], references: [usuario_id])
  fecha_venta     DateTime      @default(now())
  total           Decimal       @db.Decimal(10, 2)
  tipo_venta      TipoVenta     @default(FISICA)
  metodo_pago     MetodoPago    @default(EFECTIVO)
  estado_entrega  EstadoEntrega @default(PENDIENTE)
  qr_pago         String? // URL o base64
  comprobante_pdf String? // URL
  estado          EstadoVenta   @default(REGISTRADA)

  detalles DetalleVenta[]

  @@index([tenant_id])
}

model DetalleVenta {
  detalle_venta_id Int      @id @default(autoincrement())
  venta_id         Int
  venta            Venta    @relation(fields: [venta_id], references: [venta_id])
  producto_id      Int
  producto         Producto @relation(fields: [producto_id], references: [producto_id])
  cantidad         Int
  precio_unitario  Decimal  @db.Decimal(10, 2)
  subtotal         Decimal  @db.Decimal(10, 2)
}

model Notificacion {
  notificacion_id Int      @id @default(autoincrement())
  usuario_id      Int
  usuario         Usuario  @relation(fields: [usuario_id], references: [usuario_id])
  tipo            String // Ejemplo: STOCK_BAJO, NUEVA_VENTA
  mensaje         String
  fecha_envio     DateTime @default(now())
  leida           Boolean  @default(false)
}
